@use '../../theme/src/mixins/bem' as *;

@include b(table) {
  /* ---- 变量 ---- */
  --_bg-head:    var(--lk-fill-1);
  --_bg-body:    var(--lk-color-bg-container);
  --_bg-stripe:  var(--lk-fill-1);
  --_bg-hover:   var(--lk-bg-active);
  --_border:     var(--lk-color-border-light);
  --_text:       var(--lk-text-primary);
  --_radius:     var(--lk-radius-lg);
  --_cell-pad-x: 24rpx;
  --_cell-pad-y: 20rpx;
  --_row-h:      88rpx;
  --_head-h:     88rpx;
  --_col-min:    160rpx;

  position: relative;
  width: 100%;
  font-size: var(--lk-font-size-sm);
  color: var(--_text);
  border-radius: var(--_radius);
  overflow: hidden;

  /* ===== 传统表格外层包裹 ===== */
  @include e(wrapper) {
    position: relative;
    width: 100%;
    border-radius: var(--_radius);
    overflow: hidden;
    border: 2rpx solid var(--_border);
  }

  /* ===== 整体有边框包裹（卡片模式用） ===== */
  @include when(bordered) {
    border: 2rpx solid var(--_border);
  }

  @include e(scroll) {
    width: 100%;
  }

  /* ===== 表头 ===== */
  @include e(header) {
    background-color: var(--_bg-head);
    border-bottom: 2rpx solid var(--_border);

    @include when(sticky) {
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.06);
    }
  }

  /* ===== 行 ===== */
  @include e(tr) {
    display: flex;
    align-items: stretch;
    min-height: var(--_row-h);

    @include m(head) {
      min-height: var(--_head-h);
    }

    @include m(summary) {
      background-color: var(--lk-color-primary-soft, rgba(var(--lk-color-primary-rgb, 99 102 241) / 0.08));
      .lk-table__td {
        color: var(--lk-color-primary);
        font-weight: 600;
      }
    }

    @include when(selected) {
      background-color: var(--lk-color-primary-soft, rgba(var(--lk-color-primary-rgb, 99 102 241) / 0.08));
    }
  }

  /* ===== th / td 基础 ===== */
  @include e((th, td)) {
    /* 关键：no-shrink 让行在列多时溢出以触发横向滚动 */
    flex: 1 0 160rpx;
    min-width: 160rpx;
    padding: var(--_cell-pad-y) var(--_cell-pad-x);
    display: flex;
    align-items: center;
    box-sizing: border-box;
    overflow: hidden;
    word-break: break-all;
    line-height: 1.5;

    @include m(checkbox) {
      flex: 0 0 80rpx;
      min-width: 80rpx;
      justify-content: center;
      padding: 0;
    }

    @include m(index) {
      flex: 0 0 72rpx;
      min-width: 72rpx;
      justify-content: center;
      padding: 0;
      font-variant-numeric: tabular-nums;
      color: var(--lk-text-secondary);
    }
  }

  /* ===== 表头单元格 ===== */
  @include e(th) {
    font-weight: 500;
    font-size: var(--lk-font-size-xs);
    color: var(--lk-text-secondary);
    background-color: var(--_bg-head);
    white-space: nowrap;

    @include when(sortable) {
      cursor: pointer;
      user-select: none;
      padding-right: calc(var(--_cell-pad-x) + 28rpx);
    }
  }

  /* ===== 数据单元格 ===== */
  @include e(td) {
    border-top: 2rpx solid var(--_border);
    background-color: var(--_bg-body);
    font-size: var(--lk-font-size-sm);
    color: var(--_text);
  }

  /* ===== 表体 ===== */
  @include e(body) {
    background-color: var(--_bg-body);
  }

  /* ===== 斑马纹 ===== */
  @include when(striped) {
    @include e(tr) {
      &:nth-child(even) {
        .lk-table__td {
          background-color: var(--_bg-stripe);
        }
      }
    }
  }

  /* ===== 紧凑模式 ===== */
  @include when(compact) {
    --_cell-pad-x: 16rpx;
    --_cell-pad-y: 12rpx;
    --_row-h: 72rpx;
    --_head-h: 72rpx;
  }

  /* ===== 排序图标 ===== */
  @include e(sort-icons) {
    position: absolute;
    right: 12rpx;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    gap: 4rpx;
  }

  @include e(sort-asc) {
    width: 0;
    height: 0;
    border-left: 8rpx solid transparent;
    border-right: 8rpx solid transparent;
    border-bottom: 10rpx solid var(--lk-color-border);
    opacity: 0.4;
  }

  @include e(sort-desc) {
    width: 0;
    height: 0;
    border-left: 8rpx solid transparent;
    border-right: 8rpx solid transparent;
    border-top: 10rpx solid var(--lk-color-border);
    opacity: 0.4;
  }

  .is-sorted-asc .lk-table__sort-asc {
    opacity: 1;
    border-bottom-color: var(--lk-color-primary);
  }

  .is-sorted-desc .lk-table__sort-desc {
    opacity: 1;
    border-top-color: var(--lk-color-primary);
  }

  /* ===== 页脚 ===== */
  @include e(footer) {
    border-top: 2rpx solid var(--_border);
  }

  /* ===== 内置复选框 ===== */
  @include e(checkbox) {
    width: 40rpx;
    height: 40rpx;
    border: 3rpx solid var(--lk-color-border);
    border-radius: var(--lk-radius-sm);
    position: relative;
    box-sizing: border-box;
    flex-shrink: 0;
    transition: background-color 0.2s, border-color 0.2s;

    @include when(checked) {
      background-color: var(--lk-color-primary);
      border-color: var(--lk-color-primary);

      &::after {
        content: '';
        position: absolute;
        left: 50%;
        top: 42%;
        width: 10rpx;
        height: 18rpx;
        border: 3rpx solid #fff;
        border-top: none;
        border-left: none;
        transform: translate(-50%, -50%) rotate(45deg);
      }
    }

    @include when(indeterminate) {
      background-color: var(--lk-color-primary);
      border-color: var(--lk-color-primary);

      &::after {
        content: '';
        position: absolute;
        left: 50%;
        top: 50%;
        width: 18rpx;
        height: 3rpx;
        background-color: #fff;
        transform: translate(-50%, -50%);
      }
    }
  }

  /* ===== 工具栏 ===== */
  @include e(toolbar) {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20rpx var(--_cell-pad-x);
    background-color: var(--_bg-body);
    border-bottom: 2rpx solid var(--_border);
  }

  @include e(toolbar-left) {
    display: flex;
    align-items: center;
    gap: 12rpx;
    cursor: pointer;
  }

  @include e(toolbar-text) {
    font-size: var(--lk-font-size-sm);
    color: var(--lk-text-secondary);
  }

  @include e(toolbar-count) {
    color: var(--lk-color-primary);
    font-weight: 600;
  }

  /* ===== 卡片模式 ===== */
  @include e(cards) {
    display: flex;
    flex-direction: column;
    gap: 16rpx;
    padding: 16rpx 0;
  }

  @include e(card) {
    display: flex;
    align-items: flex-start;
    gap: 20rpx;
    padding: 28rpx var(--_cell-pad-x);
    background-color: var(--_bg-body);
    border: 2rpx solid var(--_border);
    border-radius: var(--lk-radius-md);
    transition: box-shadow 0.2s;

    @include when(selected) {
      border-color: var(--lk-color-primary);
      background-color: var(--lk-color-primary-soft, rgba(var(--lk-color-primary-rgb, 99 102 241) / 0.06));
    }
  }

  @include e(card-checkbox) {
    flex-shrink: 0;
    padding-top: 4rpx;
  }

  @include e(card-body) {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 12rpx;
  }

  @include e(card-main) {
    display: flex;
    flex-direction: column;
    gap: 6rpx;
  }

  @include e(card-primary) {
    font-size: var(--lk-font-size-base);
    font-weight: 600;
    color: var(--_text);
  }

  @include e(card-secondary) {
    display: flex;
    flex-direction: column;
    gap: 8rpx;
  }

  @include e(card-field) {
    display: flex;
    align-items: center;
    gap: 12rpx;
    font-size: var(--lk-font-size-sm);
  }

  @include e(card-label) {
    flex-shrink: 0;
    color: var(--lk-text-secondary);
    min-width: 80rpx;
  }

  @include e(card-value) {
    flex: 1;
    color: var(--_text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  @include e(card-actions) {
    display: flex;
    gap: 16rpx;
    flex-shrink: 0;
    align-items: flex-start;
    flex-direction: column;
    justify-content: center;
  }

  @include e(card-toggle) {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48rpx;
    height: 48rpx;
  }

  @include e(expand-icon) {
    width: 0;
    height: 0;
    border-left: 10rpx solid transparent;
    border-right: 10rpx solid transparent;
    border-top: 14rpx solid var(--lk-text-secondary);
    transition: transform 0.2s;

    @include when(expanded) {
      transform: rotate(180deg);
    }
  }

  @include e(card-expand) {
    margin-top: 12rpx;
    padding-top: 16rpx;
    border-top: 2rpx solid var(--_border);
    font-size: var(--lk-font-size-sm);
    color: var(--lk-text-secondary);
  }

  /* ===== 操作按钮 ===== */
  @include e(action) {
    padding: 10rpx 20rpx;
    font-size: var(--lk-font-size-xs);
    font-weight: 500;
    color: var(--lk-color-primary);
    border: 2rpx solid var(--lk-color-primary);
    border-radius: var(--lk-radius-sm);
    white-space: nowrap;
    transition: opacity 0.2s;

    &:active {
      opacity: 0.7;
    }

    @include m(danger) {
      color: var(--lk-color-danger);
      border-color: var(--lk-color-danger);
    }

    @include m(warning) {
      color: var(--lk-color-warning);
      border-color: var(--lk-color-warning);
    }
  }

  /* ===== 合计行 ===== */
  @include e(summary) {
    padding: 24rpx var(--_cell-pad-x);
    background-color: var(--_bg-head);
    border-top: 2rpx solid var(--_border);
    border-radius: 0 0 var(--_radius) var(--_radius);
  }

  @include e(summary-title) {
    font-size: var(--lk-font-size-sm);
    font-weight: 600;
    color: var(--_text);
    margin-bottom: 16rpx;
  }

  @include e(summary-content) {
    display: flex;
    flex-wrap: wrap;
    gap: 16rpx 32rpx;
  }

  @include e(summary-item) {
    display: flex;
    align-items: center;
    gap: 8rpx;
    font-size: var(--lk-font-size-sm);
  }

  @include e(summary-label) {
    color: var(--lk-text-secondary);
  }

  @include e(summary-value) {
    color: var(--lk-color-primary);
    font-weight: 600;
  }

  /* ===== 空状态 ===== */
  @include e(empty) {
    padding: 80rpx 32rpx;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16rpx;
  }

  @include e(empty-icon) {
    font-size: 80rpx;
    opacity: 0.4;
  }

  @include e(empty-text) {
    font-size: var(--lk-font-size-sm);
    color: var(--lk-text-secondary);
  }

  /* ===== 加载状态 ===== */
  @include e(loading) {
    padding: 60rpx 32rpx;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 20rpx;
  }

  @include e(loading-spinner) {
    width: 48rpx;
    height: 48rpx;
    border: 4rpx solid var(--_border);
    border-top-color: var(--lk-color-primary);
    border-radius: 50%;
    animation: lk-table-spin 0.8s linear infinite;
  }

  @include e(loading-text) {
    font-size: var(--lk-font-size-xs);
    color: var(--lk-text-secondary);
  }
}

@keyframes lk-table-spin {
  to { transform: rotate(360deg); }
}

